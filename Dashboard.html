<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Government Report</title>
  <style>
    :root {
      --bg: #2a8314;
      --panel: #17b65c;
      --panel-2: #0c8508;
      --text: #e6eaf2;
      --muted: #9aa7c7;
      --accent: #55ff4fd3;
      --ok: #19c37d;
      --warn: #ffb020;
      --danger: #ff5d5d;
      --shadow: 0 10px 30px rgba(48, 90, 16, 0.849);
      --radius: 16px;
    }
    * { box-sizing: border-box }
    html, body { height: 100% }
    body {
      margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', Arial, Noto Sans, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';
      background: radial-gradient(1200px 800px at 10% -10%, #1b2647 0%, transparent 60%),
                  radial-gradient(1200px 800px at 100% 0%, #1a2442 0%, transparent 60%),
                  var(--bg);
      color: var(--text);
    }
    header {
      position: sticky; top: 0; z-index: 10;
      background: linear-gradient(180deg, rgba(11,15,25,.9), rgba(11,15,25,.7));
      backdrop-filter: blur(8px);
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    .container { max-width: 1200px; margin: 0 auto; padding: 16px; }
    .brand { display: flex; align-items: center; gap: 12px; }
    .logo { width: 36px; height: 36px; border-radius: 10px; background: linear-gradient(135deg, var(--accent), #8a5cff); box-shadow: var(--shadow); }
    .brand h1 { margin: 0; font-size: 20px; letter-spacing: .3px; }

    nav { margin-top: 12px; display: flex; gap: 10px; flex-wrap: wrap; }
    .tab {
      appearance: none; border: 1px solid rgba(255,255,255,.1); background: var(--panel);
      padding: 10px 14px; border-radius: 999px; color: var(--text);
      cursor: pointer; transition: .2s transform, .2s background, .2s border-color;
    }
    .tab[aria-selected="true"] { background: var(--accent); border-color: transparent; }
    .tab:hover { transform: translateY(-1px) }

    main { padding: 24px 0 60px; }

    .grid { display: grid; gap: 16px; }
    @media (min-width: 900px) {
      .grid-2 { grid-template-columns: 1.2fr .8fr; }
      .grid-3 { grid-template-columns: repeat(3, 1fr); }
    }

    .card {
      background: linear-gradient(180deg, var(--panel), var(--panel-2));
      border: 1px solid rgba(255,255,255,.08);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 18px;
    }
    .card h2 { margin: 0 0 12px; font-size: 18px; }
    .subtle { color: var(--muted); font-size: 13px; }

    label { display: block; margin: 12px 0 6px; font-weight: 600; }
    input[type="text"], input[type="email"], input[type="tel"], textarea, select {
      width: 100%; padding: 10px 12px; border-radius: 12px; border: 1px solid rgba(255,255,255,.12);
      background: #14382d; color: var(--text); outline: none; box-shadow: inset 0 1px 0 rgba(255,255,255,.04);
    }
    textarea { min-height: 110px; resize: vertical; }

    .row { display: flex; gap: 12px; }
    .row > * { flex: 1 }

    button, .btn {
      appearance: none; border: none; background: var(--accent); color: white; padding: 10px 14px; border-radius: 12px; cursor: pointer; font-weight: 600; box-shadow: var(--shadow);
    }
    .btn-outline { background: transparent; border: 1px solid rgba(255,255,255,.2); color: var(--text); }
    .btn-ghost { background: transparent; color: var(--muted); border: none; }

    .chip { display:inline-flex; align-items:center; gap:8px; padding:4px 10px; border-radius:999px; font-size:12px; border:1px solid rgba(255,255,255,.12); }
    .chip.ok { background: rgba(25,195,125,.12); border-color: rgba(25,195,125,.35); }
    .chip.warn { background: rgba(255,176,32,.12); border-color: rgba(255,176,32,.35); }
    .chip.danger { background: rgba(255,93,93,.12); border-color: rgba(255,93,93,.35); }

    table { width: 100%; border-collapse: collapse; }
    th, td { text-align: left; padding: 12px; border-bottom: 1px solid rgba(255,255,255,.08); vertical-align: top; }
    th { font-size: 12px; letter-spacing: .4px; text-transform: uppercase; color: var(--muted); }

    .thumb { width: 72px; height: 72px; border-radius: 10px; object-fit: cover; border: 1px solid rgba(255,255,255,.1); }

    .footer { margin-top: 20px; display:flex; gap:8px; flex-wrap: wrap; justify-content: flex-end; }

    .empty { text-align:center; padding: 40px 10px; color: var(--muted); }

    /* Print-friendly */
    @media print {
      header, .footer, nav, .actions-only, .hide-print { display: none !important; }
      body { background: white; color: black; }
      .card { box-shadow: none; border: 1px solid #bbb; }
      .chip { border: 1px solid #888; }
    }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <h1>Government Report</h1>
      </div>
      <nav class="hide-print" role="tablist" aria-label="Sections">
        <button class="tab" role="tab" aria-selected="true" data-tab="report">Report Issue</button>
        <button class="tab" role="tab" aria-selected="false" data-tab="dashboard">Citizen Reports</button>
        <button class="tab" role="tab" aria-selected="false" data-tab="inbox">Municipal Inbox</button>
        <button class="tab" role="tab" aria-selected="false" data-tab="about">Back To dashboard</button>
         <button class="tab" role="tab" aria-selected="false" data-tab="about">Back Login</button>
      </nav>
    </div>
  </header>

  <main class="container">
    <!-- REPORT FORM -->
    <section id="report" class="grid grid-2 card" role="tabpanel" aria-labelledby="Report Issue">
      <div>
        <h2>Report an Issue</h2>
        <p class="subtle">Submit a new service delivery issue with photos and location.</p>

        <form id="issueForm">
          <label for="fullName">Your Name (optional)</label>
          <input id="fullName" type="text" placeholder="Jane Citizen" />

          <div class="row">
            <div>
              <label for="email">Email (optional)</label>
              <input id="email" type="email" placeholder="name@example.com" />
            </div>
            <div>
              <label for="phone">Phone (optional)</label>
              <input id="phone" type="tel" placeholder="060 123 4567" />
            </div>
          </div>

          <label for="category">Category</label>
          <select id="category" required>
            <option value="">Choose…</option>
            <option>Streetlight</option>
            <option>Pothole</option>
            <option>Water</option>
            <option>Electricity</option>
            <option>Sanitation</option>
            <option>Other</option>
          </select>

          <div class="row">
            <div>
              <label for="severity">Severity</label>
              <select id="severity">
                <option>Low</option>
                <option>Medium</option>
                <option>High</option>
                <option>Critical</option>
              </select>
            </div>
            <div>
              <label for="reference">Reference (optional)</label>
              <input id="reference" type="text" placeholder="e.g., Street/Block, Pole ID, etc." />
            </div>
          </div>

          <label for="description">Describe the problem</label>
          <textarea id="description" placeholder="Explain what's wrong and any useful details…" required></textarea>

          <div class="row">
            <div>
              <label for="photo">Add Photo</label>
              <input id="photo" type="file" accept="image/*" capture="environment" />
              <div id="photoPreviewWrap" class="subtle" style="margin-top:8px"></div>
            </div>
            <div>
              <label>Location</label>
              <div class="row">
                <input id="lat" type="text" inputmode="decimal" placeholder="Latitude" />
                <input id="lng" type="text" inputmode="decimal" placeholder="Longitude" />
              </div>
              <div class="row" style="margin-top:8px">
                <button type="button" class="btn-outline" id="btnLocate">Use My Location</button>
                <a id="mapsLink" class="btn-ghost" href="#" target="_blank" rel="noreferrer">Open in Maps</a>
              </div>
            </div>
          </div>

          <div class="footer">
            <button type="reset" class="btn-outline">Clear</button>
            <button type="submit">Submit Report</button>
          </div>
        </form>
      </div>

      <aside>
        <div class="card" style="height:100%">
          <h2>Tips</h2>
          <ul>
            <li>Take clear photos; include a landmark when possible.</li>
            <li>Allow location to help route to the correct ward / depot.</li>
            <li>Pick the closest category so the right team sees it first.</li>
          </ul>
          <p class="subtle">No data leaves your device in this demo. Use the export button in the dashboard to download a JSON copy for your backend.</p>
        </div>
      </aside>
    </section>

    <!-- DASHBOARD -->
    <section id="dashboard" class="card" role="tabpanel" hidden>
      <div class="row" style="align-items:center; margin-bottom:8px">
        <h2 style="margin:0">Citizen Reports</h2>
        <div style="margin-left:auto" class="row">
          <select id="filterStatus" title="Filter by status">
            <option value="">All Statuses</option>
            <option>New</option>
            <option>In Progress</option>
            <option>Resolved</option>
          </select>
          <select id="filterCategory" title="Filter by category">
            <option value="">All Categories</option>
            <option>Streetlight</option>
            <option>Pothole</option>
            <option>Water</option>
            <option>Electricity</option>
            <option>Sanitation</option>
            <option>Other</option>
          </select>
          <input id="searchText" type="text" placeholder="Search..." />
          <button id="btnExport" class="btn-outline" title="Export as JSON">Export JSON</button>
          <button id="btnClearAll" class="btn-outline" title="Delete all reports">Clear All</button>
        </div>
      </div>

      <div class="table-wrap">
        <table id="reportsTable" aria-describedby="Reports table">
          <thead>
            <tr>
              <th>Photo</th>
              <th>Category</th>
              <th>Description</th>
              <th>Location</th>
              <th>Severity</th>
              <th>Status</th>
              <th class="actions-only">Actions</th>
            </tr>
          </thead>
          <tbody id="reportsBody">
            <tr><td colspan="7" class="empty">No reports yet. Submit one on the Report tab.</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- INBOX -->
    <section id="inbox" class="grid grid-3" role="tabpanel" hidden>
      <div class="card">
        <h2>Electricity & Lighting</h2>
        <div id="inbox-electricity"></div>
      </div>
      <div class="card">
        <h2>Water & Sanitation</h2>
        <div id="inbox-water"></div>
      </div>
      <div class="card">
        <h2>Roads & Stormwater</h2>
        <div id="inbox-roads"></div>
      </div>
    </section>

    <!-- ABOUT -->
    <section id="about" class="card" role="tabpanel" hidden>
      <h2>About this Demo</h2>
      <p>This is a single-file, vanilla HTML/CSS/JS dashboard that allows citizens to file service delivery issues and routes them to the appropriate municipal team. Storage is local (in your browser) for demonstration. Hook up the export JSON to your backend (e.g., Supabase, Firebase, or a municipal API) for production.</p>
      <ul>
        <li><strong>Photo capture:</strong> Uses camera on supported devices.</li>
        <li><strong>Geolocation:</strong> Uses the browser Geolocation API.</li>
        <li><strong>Routing:</strong> Category → municipal inbox mapping.</li>
        <li><strong>Privacy:</strong> No data leaves your device in this demo.</li>
      </ul>
      <p class="subtle">Built with accessibility and print styles. Open-source friendly.</p>
    </section>
  </main>

  <template id="inboxItemTpl">
    <div class="inbox-item" style="display:flex; gap:12px; align-items:flex-start; padding:8px 0; border-bottom:1px dashed rgba(255,255,255,.08)">
      <img class="thumb" alt="Report photo preview" />
      <div style="flex:1">
        <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap">
          <span class="chip">
            <strong class="cat">Category</strong>
          </span>
          <span class="chip warn status">New</span>
          <span class="chip sev">Severity</span>
        </div>
        <div class="subtle" style="margin:8px 0"><span class="desc"></span></div>
        <div class="subtle"><span class="loc"></span></div>
        <div class="row footer">
          <button class="btn-outline markProgress">Mark In Progress</button>
          <button class="btn-outline" style="border-color:rgba(25,195,125,.5)" data-action="resolve">Resolve</button>
        </div>
      </div>
    </div>
  </template>

  <script>
    // ---------- Utilities ----------
    const $ = (sel, root = document) => root.querySelector(sel);
    const $$ = (sel, root = document) => Array.from(root.querySelectorAll(sel));

    const storeKey = 'civic_reports_v1';

    function loadReports() {
      try { return JSON.parse(localStorage.getItem(storeKey)) || []; }
      catch { return []; }
    }
    function saveReports(list) {
      localStorage.setItem(storeKey, JSON.stringify(list));
    }

    function toDataURL(file, max = 1280) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => {
          const img = new Image();
          img.onload = () => {
            const scale = Math.min(1, max / Math.max(img.width, img.height));
            const canvas = document.createElement('canvas');
            canvas.width = Math.round(img.width * scale);
            canvas.height = Math.round(img.height * scale);
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            resolve(canvas.toDataURL('image/jpeg', .8));
          };
          img.onerror = reject;
          img.src = reader.result;
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    function mapsHref(lat, lng) {
      return `https://www.google.com/maps?q=${encodeURIComponent(lat)},${encodeURIComponent(lng)}`;
    }

    function nowISO() { return new Date().toISOString(); }

    function statusChip(status) {
      const cls = status === 'Resolved' ? 'ok' : status === 'In Progress' ? 'warn' : 'danger';
      return `<span class="chip ${cls}">${status}</span>`;
    }

    function deptForCategory(cat) {
      switch ((cat||'').toLowerCase()) {
        case 'streetlight':
        case 'electricity':
          return 'electricity';
        case 'water':
        case 'sanitation':
          return 'water';
        case 'pothole':
        default:
          return 'roads';
      }
    }

    // ---------- Tabs ----------
    $$('.tab').forEach(btn => btn.addEventListener('click', () => {
      const id = btn.dataset.tab;
      $$('.tab').forEach(b => b.setAttribute('aria-selected', b===btn ? 'true' : 'false'));
      $$('main > section').forEach(sec => sec.hidden = sec.id !== id);
    }));

    // ---------- Photo preview ----------
    const photoInput = $('#photo');
    const photoPreviewWrap = $('#photoPreviewWrap');
    let photoDataURL = '';

    photoInput?.addEventListener('change', async () => {
      photoPreviewWrap.innerHTML = '';
      photoDataURL = '';
      const file = photoInput.files?.[0];
      if (!file) return;
      const data = await toDataURL(file);
      photoDataURL = data;
      const img = new Image();
      img.src = data; img.className = 'thumb'; img.alt = 'Selected photo preview';
      photoPreviewWrap.appendChild(img);
    });

    // ---------- Geolocation ----------
    $('#btnLocate')?.addEventListener('click', () => {
      if (!('geolocation' in navigator)) return alert('Geolocation not supported on this device.');
      navigator.geolocation.getCurrentPosition(pos => {
        const { latitude, longitude } = pos.coords;
        $('#lat').value = latitude.toFixed(6);
        $('#lng').value = longitude.toFixed(6);
        $('#mapsLink').href = mapsHref(latitude, longitude);
      }, err => {
        alert('Unable to get your location: ' + err.message);
      }, { enableHighAccuracy: true, timeout: 15000 });
    });

    $('#lat')?.addEventListener('input', syncMapsLink);
    $('#lng')?.addEventListener('input', syncMapsLink);
    function syncMapsLink(){
      const lat = $('#lat').value.trim();
      const lng = $('#lng').value.trim();
      if(lat && lng) $('#mapsLink').href = mapsHref(lat,lng);
    }

    // ---------- Submit form ----------
    const form = $('#issueForm');
    form?.addEventListener('submit', (e) => {
      e.preventDefault();
      const report = {
        id: 'R' + Math.random().toString(36).slice(2,9).toUpperCase(),
        createdAt: nowISO(),
        fullName: $('#fullName').value.trim(),
        email: $('#email').value.trim(),
        phone: $('#phone').value.trim(),
        category: $('#category').value,
        severity: $('#severity').value,
        reference: $('#reference').value.trim(),
        description: $('#description').value.trim(),
        lat: $('#lat').value.trim(),
        lng: $('#lng').value.trim(),
        photo: photoDataURL,
        status: 'New',
        dept: deptForCategory($('#category').value)
      };

      if (!report.category) return alert('Please choose a category.');
      if (!report.description) return alert('Please provide a description.');

      const reports = loadReports();
      reports.unshift(report);
      saveReports(reports);
      renderTable();
      renderInboxes();

      form.reset();
      photoPreviewWrap.innerHTML = '';
      photoDataURL = '';
      alert('Report submitted! You can track it in the Citizen Reports tab.');
    });

    // ---------- Render table ----------
    const tbody = $('#reportsBody');

    function renderTable() {
      const reports = loadReports();
      const fStatus = $('#filterStatus').value;
      const fCat = $('#filterCategory').value;
      const q = $('#searchText').value.toLowerCase();

      const filtered = reports.filter(r =>
        (!fStatus || r.status === fStatus) &&
        (!fCat || r.category === fCat) &&
        (!q || [r.id, r.category, r.description, r.reference, r.fullName, r.email, r.phone].join(' ').toLowerCase().includes(q))
      );

      if (!filtered.length) {
        tbody.innerHTML = `<tr><td colspan="7" class="empty">No matching reports.</td></tr>`;
        return;
      }

      tbody.innerHTML = filtered.map(r => `
        <tr data-id="${r.id}">
          <td>${r.photo ? `<img src="${r.photo}" alt="photo" class="thumb"/>` : '<span class="subtle">No photo</span>'}</td>
          <td>
            <div style="font-weight:700">${r.category}</div>
            <div class="subtle">#${r.id}</div>
          </td>
          <td>${escapeHtml(r.description)}${r.reference ? `<div class="subtle">Ref: ${escapeHtml(r.reference)}</div>`:''}<div class="subtle">Created: ${new Date(r.createdAt).toLocaleString()}</div></td>
          <td>${(r.lat && r.lng) ? `<a href="${mapsHref(r.lat,r.lng)}" target="_blank" rel="noreferrer">${r.lat}, ${r.lng}</a>` : '<span class="subtle">Not provided</span>'}</td>
          <td>${r.severity}</td>
          <td>${statusChip(r.status)}</td>
          <td class="actions-only">
            <div class="row">
              <button class="btn-outline" data-action="progress">In&nbsp;Progress</button>
              <button class="btn-outline" style="border-color:rgba(25,195,125,.5)" data-action="resolve">Resolve</button>
              <button class="btn-outline" style="border-color:rgba(255,93,93,.5)" data-action="delete">Delete</button>
            </div>
          </td>
        </tr>
      `).join('');
    }

    function escapeHtml(s='') { return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m])); }

    // table action handlers
    tbody?.addEventListener('click', (e) => {
      const btn = e.target.closest('button[data-action]');
      if (!btn) return;
      const tr = e.target.closest('tr');
      const id = tr?.dataset.id; if (!id) return;
      const reports = loadReports();
      const idx = reports.findIndex(r => r.id === id);
      if (idx === -1) return;
      const action = btn.dataset.action;
      if (action === 'delete') {
        if (confirm('Delete this report?')) { reports.splice(idx,1); }
      } else if (action === 'resolve') {
        reports[idx].status = 'Resolved';
      } else if (action === 'progress') {
        reports[idx].status = 'In Progress';
      }
      saveReports(reports);
      renderTable();
      renderInboxes();
    });

    // filters
    $('#filterStatus')?.addEventListener('change', renderTable);
    $('#filterCategory')?.addEventListener('change', renderTable);
    $('#searchText')?.addEventListener('input', renderTable);

    // export
    $('#btnExport')?.addEventListener('click', () => {
      const blob = new Blob([localStorage.getItem(storeKey) || '[]'], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `civic-reports-${new Date().toISOString().slice(0,10)}.json`;
      a.click();
      URL.revokeObjectURL(url);
    });

    // clear all
    $('#btnClearAll')?.addEventListener('click', () => {
      if (confirm('This will delete ALL reports stored in your browser. Continue?')) {
        saveReports([]); renderTable(); renderInboxes();
      }
    });

    // ---------- Municipal Inbox ----------
    function renderInboxes() {
      const reports = loadReports();
      const sections = {
        electricity: $('#inbox-electricity'),
        water: $('#inbox-water'),
        roads: $('#inbox-roads')
      };
      Object.values(sections).forEach(el => el.innerHTML = '');

      if (!reports.length) {
        Object.values(sections).forEach(el => el.innerHTML = '<div class="empty">No incoming reports.</div>');
        return;
      }

      for (const r of reports) {
        const host = sections[r.dept] || sections.roads;
        host.appendChild(buildInboxItem(r));
      }

      // Attach action buttons
      $$('#inbox .markProgress').forEach(btn => btn.addEventListener('click', (e) => {
        const id = e.target.closest('[data-id]')?.dataset.id; if (!id) return;
        updateStatus(id, 'In Progress');
      }));
      $$('#inbox [data-action="resolve"]').forEach(btn => btn.addEventListener('click', (e) => {
        const id = e.target.closest('[data-id]')?.dataset.id; if (!id) return;
        updateStatus(id, 'Resolved');
      }));
    }

    function buildInboxItem(r) {
      const tpl = $('#inboxItemTpl').content.cloneNode(true);
      const wrap = tpl.querySelector('.inbox-item');
      wrap.dataset.id = r.id;
      const img = tpl.querySelector('img');
      if (r.photo) { img.src = r.photo; img.alt = r.category + ' photo'; }
      else { img.replaceWith(Object.assign(document.createElement('div'), { className:'thumb subtle', innerText:'No photo' })); }
      tpl.querySelector('.cat').innerText = r.category;
      tpl.querySelector('.status').innerText = r.status;
      tpl.querySelector('.sev').innerText = 'Severity: ' + r.severity;
      tpl.querySelector('.desc').innerText = r.description;
      tpl.querySelector('.loc').innerHTML = (r.lat && r.lng) ? `<a href="${mapsHref(r.lat,r.lng)}" target="_blank" rel="noreferrer">${r.lat}, ${r.lng}</a>` : 'Location not provided';
      return tpl;
    }

    function updateStatus(id, status) {
      const reports = loadReports();
      const r = reports.find(x => x.id === id);
      if (!r) return;
      r.status = status;
      saveReports(reports);
      renderTable();
      renderInboxes();
    }

    // ---------- Init ----------
    renderTable();
    renderInboxes();
  </script>
</body>
</html>
