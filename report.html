<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Report an Issue</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <header>
    <div class="container" style="display: flex; align-items: center; justify-content: space-between;">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <h1>Government Report</h1>
      </div>
      <div>
        <a href="Login.html" class="btn-outline" style="margin-left:auto;">Back to Login</a>
        <a href="user-dash.html" class="btn-outline" style="margin-left:12px;">Dash</a>
      </div>
    </div>
  </header>
  <main class="container">
    <section id="report" class="grid grid-2 card" role="tabpanel" aria-labelledby="Report Issue">
      <div>
        <h2>Report an Issue</h2>
        <p class="subtle">Submit a new service delivery issue with photos and location.</p>
        <form id="issueForm">
          <label for="fullName">Your Name</label>
          <input id="fullName" type="text" placeholder="Jane Citizen" />

          <div class="row">
            <div>
              <label for="email">Email</label>
              <input id="email" type="email" placeholder="name@example.com" />
            </div>
            <div>
              <label for="phone">Phone</label>
              <input id="phone" type="tel" placeholder="060 123 4567" />
            </div>
          </div>

          <label for="category">Category</label>
          <select id="category" required>
            <option value="">Choose…</option>
            <option>Streetlight</option>
            <option>Pothole</option>
            <option>Water</option>
            <option>Electricity</option>
            <option>Sanitation</option>
            <option>Other</option>
          </select>

          <div class="row">
            <div>
              <label for="severity">Severity</label>
              <select id="severity">
                <option>Low</option>
                <option>Medium</option>
                <option>High</option>
                <option>Critical</option>
              </select>
            </div>
            <div>
              <label for="reference">Reference</label>
              <input id="reference" type="text" placeholder="e.g., Street/Block, Pole ID, etc." />
            </div>
          </div>

          <label for="description">Describe the problem</label>
          <textarea id="description" placeholder="Explain what's wrong and any useful details…" required></textarea>

          <div class="row">
            <div>
              <label for="photo">Add Photo</label>
              <div style="display:flex;align-items:center;gap:8px;">
                <input id="photo" type="file" accept="image/*" capture="environment" style="display:none;" />
                <label for="photo" id="photoLabel" style="cursor:pointer;display:inline-flex;align-items:center;gap:6px;padding:8px 14px;border-radius:10px;background:#f3f3f3;border:1px solid #ddd;">
                  <!-- SVG icon -->
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather feather-share"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path><polyline points="16 6 12 2 8 6"></polyline><line x1="12" y1="2" x2="12" y2="15"></line></svg>
                  <span>Add Photo</span>
                </label>
              </div>
              <div id="photoPreviewWrap" class="subtle" style="margin-top:8px"></div>
            </div>
            <div>
              <label>Location</label>
              <div class="row">
                <input id="lat" type="text" inputmode="decimal" placeholder="Latitude" />
                <input id="lng" type="text" inputmode="decimal" placeholder="Longitude" />
              </div>
              <div class="row" style="margin-top:8px">
                <button type="button" class="btn-outline" id="btnPickLocation">Pick Location on Map</button>
                <button type="button" class="btn-outline" id="btnUseLocation" style="margin-left:8px;">Use My Location</button>
                <span class="subtle" style="margin-left:8px;">Drop a pin on Google Maps, copy coordinates, or use your current location.</span>
              </div>
            </div>
          </div>

          <div class="footer">
            <button type="reset" class="btn-outline">Clear</button>
            <button type="submit">Submit Report</button>
          </div>
        </form>
      </div>
      <aside>
        <div class="card" style="height:100%">
          <h2>Tips</h2>
          <ul>
            <li>Take clear photos; include a landmark when possible.</li>
            <li>Pick the closest category so the right team sees it first.</li>
            <li>Drop a pin on Google Maps for accurate location.</li>
          </ul>
        </div>
      </aside>
    </section>
  </main>
  <script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const SUPABASE_URL = 'https://cwgidwpxsldxzmknpobq.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN3Z2lkd3B4c2xkeHpta25wb2JxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY0OTI0ODcsImV4cCI6MjA3MjA2ODQ4N30.Z791cAUdW0i9HB7o7oJrQBtTurIv721RC35kLZfOLdY';

const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const form = document.getElementById("issueForm");
const photoInput = document.getElementById("photo");
const latInput = document.getElementById("lat");
const lngInput = document.getElementById("lng");
const photoPreviewWrap = document.getElementById("photoPreviewWrap");
const btnPickLocation = document.getElementById("btnPickLocation");
const btnUseLocation = document.getElementById("btnUseLocation");

// --- PHOTO PREVIEW ---
photoInput.addEventListener("change", async () => {
  photoPreviewWrap.innerHTML = "";
  const file = photoInput.files?.[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = () => {
    const img = new Image();
    img.src = reader.result;
    img.className = "thumb";
    img.alt = "Selected photo preview";
    photoPreviewWrap.appendChild(img);
  };
  reader.readAsDataURL(file);
});

// --- PICK LOCATION BUTTON ---
btnPickLocation.addEventListener("click", () => {
  window.open("https://www.google.com/maps", "_blank");
});

// --- USE CURRENT LOCATION BUTTON ---
btnUseLocation.addEventListener("click", () => {
  if (!navigator.geolocation) {
    alert("Geolocation is not supported by your browser.");
    return;
  }
  btnUseLocation.disabled = true;
  btnUseLocation.textContent = "Locating...";
  navigator.geolocation.getCurrentPosition(
    (pos) => {
      latInput.value = pos.coords.latitude.toFixed(6);
      lngInput.value = pos.coords.longitude.toFixed(6);
      btnUseLocation.disabled = false;
      btnUseLocation.textContent = "Use My Location";
    },
    (err) => {
      alert("Unable to get your location: " + err.message);
      btnUseLocation.disabled = false;
      btnUseLocation.textContent = "Use My Location";
    },
    { enableHighAccuracy: true, timeout: 15000 }
  );
});

// --- PHOTO UPLOAD FUNCTION ---
async function uploadPhoto(file) {
  if (!file) return null;
  const fileName = `${Date.now()}-${file.name}`;
  const { data, error } = await supabase.storage
    .from("report-photos")
    .upload(fileName, file);
  if (error) {
    console.error("Photo upload error:", error.message);
    return null;
  }
  const { data: publicUrlData } = supabase.storage
    .from("report-photos")
    .getPublicUrl(fileName);
  return publicUrlData.publicUrl;
}

// --- FORM SUBMIT HANDLER ---
form.addEventListener("submit", async (e) => {
  e.preventDefault();

  const file = photoInput.files[0];
  let photoUrl = null;
  if (file) {
    photoUrl = await uploadPhoto(file);
  }

  // Prepare user info
  const user = {
    name: document.getElementById("fullName").value,
    email: document.getElementById("email").value,
    phone: document.getElementById("phone").value,
    ward: "1"
  };

  // Insert user info (no duplicate check for simplicity)
  await supabase.from("users").insert([user]);

  // Prepare report info
  const report = {
    ...user,
    category: document.getElementById("category").value,
    severity: document.getElementById("severity").value,
    reference: document.getElementById("reference").value,
    description: document.getElementById("description").value,
    latitude: latInput.value ? parseFloat(latInput.value) : null,
    longitude: lngInput.value ? parseFloat(lngInput.value) : null,
    photo_url: photoUrl,
  };

  const { error } = await supabase.from("reports").insert([report]);
  if (error) {
    alert("Error saving report: " + error.message);
  } else {
    alert("Report submitted successfully!");
    form.reset();
    photoPreviewWrap.innerHTML = "";
  }
  
});
</script>
</body>
</html>
